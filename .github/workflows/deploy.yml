name: Deploy Next.js App to EC2

on:
  push:
    branches:
      - main # or your deployment branch

jobs:
  deploy:
    name: Build and Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Check out repository code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Install dependencies and build Next.js
        run: |
          npm ci
          npm run build

      - name: ğŸ“¦ Prepare deployment package
        run: |
          mkdir deploy
          cp -r .next package.json package-lock.json deploy/
          if [ -f next.config.ts ]; then cp next.config.ts deploy/; fi
          if [ -f next.config.js ]; then cp next.config.js deploy/; fi
          cd deploy && tar -czf ../ci-cd-demo.tar.gz .

      - name: ğŸš€ Upload to EC2 and deploy
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 13.201.78.81
          username: ubuntu
          key: ${{ secrets.PRIVATE_SSH_KEY }}
          port: 22
          source: "ci-cd-demo.tar.gz"
          target: "~/"

      - name: ğŸ§© Connect via SSH and deploy
        uses: appleboy/ssh-action@v1
        with:
          host: 13.201.78.81
          username: ubuntu
          key: ${{ secrets.PRIVATE_SSH_KEY }}
          port: 22
          script: |
            rm -rf ~/ci-cd-demo
            mkdir ~/ci-cd-demo
            tar -xzf ~/ci-cd-demo.tar.gz -C ~/ci-cd-demo
            cd ~/ci-cd-demo
            npm ci --omit=dev
            pm2 delete nextjs || true
            pm2 start npm --name "cid1" -- run start
