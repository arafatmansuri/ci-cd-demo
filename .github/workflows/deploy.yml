name: Deploy Next.js App to EC2

on:
  push:
    branches:
      - main # or your deployment branch

jobs:
  deploy:
    name: Build and Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Check out repository code
        uses: actions/checkout@v4

      - name: üèóÔ∏è Install dependencies and build Next.js
        run: |
          npm ci
          npm run build

      - name: üì¶ Prepare deployment package
        run: |
          mkdir deploy
          cp -r .next package.json package-lock.json deploy/
          if [ -f next.config.ts ]; then cp next.config.ts deploy/; fi
          if [ -f next.config.js ]; then cp next.config.js deploy/; fi
          cd deploy && tar -czf ../ci-cd-demo.tar.gz .

      - name: üöÄ Upload to EC2 and deploy
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 13.201.78.81
          username: ubuntu
          key: ${{ secrets.PRIVATE_SSH_KEY }}
          port: 22
          source: "ci-cd-demo.tar.gz"
          target: "~/"

      - name: üß© Connect via SSH and deploy
        uses: appleboy/ssh-action@v1
        with:
          host: 13.201.78.81
          username: ubuntu
          key: ${{ secrets.PRIVATE_SSH_KEY }}
          port: 22
          script: |
            # Load environment paths for Node and PM2
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

            rm -rf ~/next-app
            mkdir ~/next-app
            tar -xzf ~/next-app.tar.gz -C ~/next-app
            cd ~/next-app
            npm ci --omit=dev
            pm2 delete nextjs || true
            pm2 start npm --name "nextjs" -- run start
